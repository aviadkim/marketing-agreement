<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הסכם שיווק השקעות - הצהרות</title>
    <link href="/css/styles.css" rel="stylesheet">
    <style>
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .message {
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Header with Logo -->
    <header class="form-header">
        <img src="/images/movne-logo.png" alt="מובנה" class="logo">
        <h1>הסכם שיווק השקעות חד פעמי למוצרים מובנים</h1>
    </header>

    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-steps">
            <div class="step completed" data-step="1">
                <div class="step-circle">
                    <span class="step-number">1</span>
                    <span class="step-check">✓</span>
                </div>
                <div class="step-label">פרטים אישיים</div>
            </div>
            <div class="step completed" data-step="2">
                <div class="step-circle">
                    <span class="step-number">2</span>
                    <span class="step-check">✓</span>
                </div>
                <div class="step-label">פרטי השקעה</div>
            </div>
            <div class="step completed" data-step="3">
                <div class="step-circle">
                    <span class="step-number">3</span>
                    <span class="step-check">✓</span>
                </div>
                <div class="step-label">שאלון סיכון</div>
            </div>
            <div class="step active" data-step="4">
                <div class="step-circle">
                    <span class="step-number">4</span>
                    <span class="step-check">✓</span>
                </div>
                <div class="step-label">הצהרות</div>
            </div>
        </div>
    </div>

    <!-- Form Content -->
    <main class="form-content">
        <form id="section4-form" class="form-section">
            <!-- Declarations Accordion -->
            <div class="accordion-container">
                <div class="accordion-item" data-declaration="declaration1">
                    <button type="button" class="accordion-header">
                        <span class="accordion-title">הצהרת הבנת סיכונים</span>
                        <span class="accordion-icon">▼</span>
                    </button>
                    <div class="accordion-content">
                        <p class="mb-4">
                            אני מצהיר/ה בזאת כי הובהר לי שההשקעה במוצרים מובנים כרוכה בסיכונים מיוחדים, לרבות:
                        </p>
                        <ul class="declaration-list">
                            <li>סיכון לאובדן חלק או כל הקרן המושקעת</li>
                            <li>סיכוני שוק ותנודתיות</li>
                            <li>סיכוני נזילות ואפשרות מוגבלת למכירה לפני מועד הפירעון</li>
                            <li>סיכוני מטבע ושערי חליפין במידה ורלוונטי</li>
                            <li>תלות בחוסנם הפיננסי של מנפיקי המוצרים המובנים</li>
                            <li>מורכבות המוצרים והקושי בהערכת שווים</li>
                        </ul>
                        <label class="checkbox-container mt-4">
                            <input type="checkbox" name="riskAcknowledgement" required>
                            <span class="checkmark"></span>
                            קראתי והבנתי את כל הסיכונים המפורטים לעיל
                        </label>
                    </div>
                </div>

                <div class="accordion-item" data-declaration="declaration2">
                    <button type="button" class="accordion-header">
                        <span class="accordion-title">הצהרת אי הסתמכות והחלטה עצמאית</span>
                        <span class="accordion-icon">▼</span>
                    </button>
                    <div class="accordion-content">
                        <p class="mb-4">אני מצהיר/ה בזאת כי:</p>
                        <ul class="declaration-list">
                            <li>ההחלטה להשקיע במוצרים מובנים התקבלה על פי שיקול דעתי העצמאי בלבד</li>
                            <li>איני מסתמך/ת על עצות או המלצות של החברה או מי מטעמה</li>
                            <li>הובהר לי שהחברה אינה משמשת כיועץ השקעות ואינה מספקת ייעוץ אישי</li>
                            <li>בדקתי את התאמת ההשקעה לצרכיי ולמטרותיי הפיננסיות</li>
                            <li>אני מבין/ה שביצועי עבר אינם מעידים על ביצועים עתידיים</li>
                        </ul>
                        <label class="checkbox-container mt-4">
                            <input type="checkbox" name="independentDecision" required>
                            <span class="checkmark"></span>
                            אני מאשר/ת את כל ההצהרות הנ"ל
                        </label>
                    </div>
                </div>

                <div class="accordion-item" data-declaration="declaration3">
                    <button type="button" class="accordion-header">
                        <span class="accordion-title">התחייבות לעדכון פרטים</span>
                        <span class="accordion-icon">▼</span>
                    </button>
                    <div class="accordion-content">
                        <p class="mb-4">אני מתחייב/ת בזאת:</p>
                        <ul class="declaration-list">
                            <li>לעדכן את החברה בכתב על כל שינוי מהותי בפרטים שמסרתי בטופס זה</li>
                            <li>להודיע מיידית על כל שינוי במצבי הפיננסי שעשוי להשפיע על השקעותיי</li>
                            <li>לעדכן על שינויים בנסיבות האישיות שעשויים להשפיע על פרופיל הסיכון שלי</li>
                            <li>להודיע על שינויים במטרות ההשקעה או באופק ההשקעה המתוכנן</li>
                        </ul>
                        <label class="checkbox-container mt-4">
                            <input type="checkbox" name="updateCommitment" required>
                            <span class="checkmark"></span>
                            אני מתחייב/ת לעדכן על כל שינוי מהותי כמפורט לעיל
                        </label>
                    </div>
                </div>
            </div>

            <!-- Signature Section -->
            <div class="signature-section mt-6">
                <h3>חתימה דיגיטלית</h3>
                <div class="signature-container">
                    <canvas id="signatureCanvas" class="signature-canvas"></canvas>
                    <div class="signature-controls">
                        <button type="button" class="btn-secondary" data-clear-signature>נקה חתימה</button>
                        <button type="button" class="btn-secondary" data-copy-signature>הדבק חתימה קודמת</button>
                    </div>
                </div>
                <input type="hidden" id="signatureData" name="signature" required>
            </div>

            <!-- Final Confirmation -->
            <div class="final-confirmation mt-6">
                <label class="checkbox-container">
                    <input type="checkbox" name="finalConfirmation" required>
                    <span class="checkmark"></span>
                    <span class="text-bold">
                        אני מאשר/ת שקראתי והבנתי את כל ההצהרות לעיל, ומסכים/ה להן באופן מלא ובלתי חוזר
                    </span>
                </label>
            </div>
        </form>
    </main>

    <!-- Navigation -->
    <footer class="form-navigation">
        <div class="container">
            <button type="button" id="btnBack" class="btn-prev">חזור</button>
            <button type="button" id="finalSubmit" class="btn-next" disabled>סיים והגש טופס</button>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="/js/signatureHandler.js"></script>
    <script src="/js/accordion.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/navigation.js"></script>
    <script src="/js/googleSheetsSubmit.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('#section4-form');
            const submitButton = document.getElementById('finalSubmit');

            // Initialize signature pad
            const signaturePad = new SignaturePad(document.getElementById('signatureCanvas'), {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)'
            });

            // Function to check form validity
            function checkFormValidity() {
                const allCheckboxesChecked = 
                    form.querySelector('input[name="riskAcknowledgement"]').checked &&
                    form.querySelector('input[name="independentDecision"]').checked &&
                    form.querySelector('input[name="updateCommitment"]').checked &&
                    form.querySelector('input[name="finalConfirmation"]').checked;

                const hasSignature = !signaturePad.isEmpty();

                submitButton.disabled = !(allCheckboxesChecked && hasSignature);
            }

            // Add event listeners for form changes
            form.addEventListener('change', checkFormValidity);

            // Monitor signature changes
            signaturePad.onEnd = checkFormValidity;

            // Handle signature clear button
            document.querySelector('[data-clear-signature]').addEventListener('click', function() {
                signaturePad.clear();
                document.getElementById('signatureData').value = '';
                checkFormValidity();
            });

            // Handle signature copy button
            document.querySelector('[data-copy-signature]').addEventListener('click', function() {
                const lastSignature = localStorage.getItem('lastSignature');
                if (lastSignature) {
                    signaturePad.fromDataURL(lastSignature);
                    document.getElementById('signatureData').value = lastSignature;
                    checkFormValidity();
                }
            });

            // Handle form submission
            submitButton.addEventListener('click', async function(e) {
                e.preventDefault();
                
                if (form.checkValidity() && !signaturePad.isEmpty()) {
                    const buttonText = this.innerHTML;
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner"></span>';

                    try {
                        // Save signature
                        const signatureData = signaturePad.toDataURL();
                        document.getElementById('signatureData').value = signatureData;
                        localStorage.setItem('lastSignature', signatureData);

                        // Save form data
                        const formData = new FormData(form);
                        const dataToSave = {};
                        formData.forEach((value, key) => {
                            dataToSave[key] = value;
                        });
                        dataToSave.signature = signatureData;
                        localStorage.setItem('section4Data', JSON.stringify(dataToSave));

                        // Submit form
                        const success = await window.submitFormToGoogleSheets();

                        if (success) {
                            window.showMessage('הטופס נשלח בהצלחה', 'success');
                            window.clearFormData();
                            window.location.href = '/sections/preview.html';
                        }
                    } catch (error) {
                        console.error('Submission error:', error);
                        window.showMessage(error.message || 'אירעה שגיאה בשליחת הטופס. נא לנסות שוב.', 'error');
                    } finally {
                        this.disabled = false;
                        this.innerHTML = buttonText;
                    }
                } else {
                    if (signaturePad.isEmpty()) {
                        window.showMessage('נא להוסיף חתימה', 'error');
                    } else {
                        window.showMessage('נא למלא את כל השדות הנדרשים', 'error');
                    }
                }
            });

            // Handle back button
            document.getElementById('btnBack').addEventListener('click', function() {
                window.location.href = '/sections/section3.html';
            });

            // Load saved data
            const savedData = localStorage.getItem('section4Data');
            if (savedData) {
                const data = JSON.parse(savedData);
                Object.entries(data).forEach(([key, value]) => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input && input.type === 'checkbox') {
                        input.checked = value === 'on' || value === true;
                    }
                });

                // Restore signature if available
                if (data.signature) {
                    signaturePad.fromDataURL(data.signature);
                    document.getElementById('signatureData').value = data.signature;
                }
            }

            // Initialize accordion
            const accordionItems = document.querySelectorAll('.accordion-item');
            accordionItems.forEach(item => {
                const header = item.querySelector('.accordion-header');
                const content = item.querySelector('.accordion-content');
                
                header.addEventListener('click', () => {
                    // Toggle current accordion
                    const isOpen = item.classList.contains('open');
                    
                    // Close all accordions
                    accordionItems.forEach(otherItem => {
                        otherItem.classList.remove('open');
                        otherItem.querySelector('.accordion-content').style.maxHeight = null;
                        otherItem.querySelector('.accordion-icon').textContent = '▼';
                    });
                    
                    // Open current if it was closed
                    if (!isOpen) {
                        item.classList.add('open');
                        content.style.maxHeight = content.scrollHeight + "px";
                        item.querySelector('.accordion-icon').textContent = '▲';
                    }
                });
            });

            // Open first accordion by default
            if (accordionItems.length > 0) {
                const firstItem = accordionItems[0];
                const firstContent = firstItem.querySelector('.accordion-content');
                firstItem.classList.add('open');
                firstContent.style.maxHeight = firstContent.scrollHeight + "px";
                firstItem.querySelector('.accordion-icon').textContent = '▲';
            }

            // Initial validity check
            checkFormValidity();
        });
    </script>
</body>
</html>
