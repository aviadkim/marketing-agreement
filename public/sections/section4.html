document.addEventListener('DOMContentLoaded', function() {
    const declarations = {
        declaration1: false,
        declaration2: false,
        declaration3: false
    };

    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', function() {
            const content = this.nextElementSibling;
            const icon = this.querySelector('.accordion-icon');
            const isOpen = content.classList.contains('open');
            const declarationId = this.closest('.accordion-item').dataset.declaration;

            document.querySelectorAll('.accordion-content').forEach(item => {
                item.classList.remove('open');
                item.style.maxHeight = null;
                item.previousElementSibling.querySelector('.accordion-icon').textContent = '▼';
            });

            if (!isOpen) {
                content.classList.add('open');
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.textContent = '▲';
                
                setTimeout(() => {
                    declarations[declarationId] = true;
                    updateProgressMarkers();
                    checkAllDeclarationsRead();
                }, 1000);
            }
        });
    });

    document.querySelectorAll('.accordion-content').forEach(content => {
        content.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });

    document.querySelectorAll('.checkbox-container input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const declarationId = this.closest('.accordion-item')?.dataset.declaration;
            if (declarationId) {
                declarations[declarationId] = this.checked;
                updateProgressMarkers();
            }
            checkAllDeclarationsRead();
        });
    });

    document.querySelectorAll('.form-group input, .form-group select').forEach(input => {
        input.addEventListener('change', function() {
            validateInput(this);
        });
    });

    function updateProgressMarkers() {
        Object.entries(declarations).forEach(([id, isRead]) => {
            const marker = document.querySelector(`.progress-marker[data-declaration="${id}"]`);
            if (marker) {
                if (isRead) {
                    marker.classList.add('completed');
                } else {
                    marker.classList.remove('completed');
                }
            }
        });
    }

    function checkAllDeclarationsRead() {
        const allRead = Object.values(declarations).every(val => val);
        const finalCheckbox = document.querySelector('input[name="finalConfirmation"]');
        
        if (finalCheckbox) {
            finalCheckbox.disabled = !allRead;
            if (allRead) {
                finalCheckbox.closest('.final-confirmation').classList.add('enabled');
            }
        }

        updateSubmitButton();
    }

    function validateInput(input) {
        const isValid = input.checkValidity();
        const formGroup = input.closest('.form-group');
        
        if (formGroup) {
            if (isValid) {
                formGroup.classList.remove('has-error');
                formGroup.classList.add('is-valid');
            } else {
                formGroup.classList.add('has-error');
                formGroup.classList.remove('is-valid');
            }
        }

        updateSubmitButton();
    }

    function validateForm() {
        let isValid = true;
        const requiredInputs = document.querySelectorAll('input[required], select[required]');
        
        requiredInputs.forEach(input => {
            if (!input.checkValidity()) {
                isValid = false;
                const formGroup = input.closest('.form-group');
                if (formGroup) {
                    formGroup.classList.add('has-error');
                }
            }
        });

        return isValid;
    }

    function updateSubmitButton() {
        const submitButton = document.getElementById('finalSubmit');
        const form = document.getElementById('section4-form');
        
        if (submitButton && form) {
            submitButton.disabled = !validateForm();
        }
    }

    document.getElementById('finalSubmit').addEventListener('click', async function(e) {
        e.preventDefault();
        console.log('Submit button clicked');

        const signatureData = document.getElementById('signatureCanvas4-data').value;
        if (!signatureData) {
            alert('נא להוסיף חתימה דיגיטלית');
            const signatureContainer = document.querySelector('.signature-container');
            signatureContainer.scrollIntoView({ behavior: 'smooth' });
            return;
        }

        const allChecked = ['riskAcknowledgement', 'independentDecision', 'updateCommitment', 'finalConfirmation']
            .every(name => {
                const checked = document.querySelector(`input[name="${name}"]`).checked;
                console.log(`Checkbox ${name}:`, checked);
                return checked;
            });

        if (!allChecked) {
            alert('נא לקרוא ולאשר את כל ההצהרות');
            return;
        }

        await submitForm();
    });

    document.getElementById('btnBack').addEventListener('click', function() {
        window.location.href = 'section3.html';
    });

    async function submitForm() {
        try {
            const form = document.getElementById('section4-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            console.log('Submitting form data:', data);

            const response = await fetch('/api/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error('שגיאה בשליחת הטופס');
            }

            const result = await response.json();
            
            if (result.success) {
                // שמירת הנתונים ב-localStorage
                Object.entries(data).forEach(([key, value]) => {
                    localStorage.setItem(`section4_${key}`, value);
                });
                
                alert('הטופס נשלח בהצלחה!');
                window.location.href = '/thank-you.html';
            } else {
                throw new Error(result.message || 'שגיאה בשליחת הטופס');
            }
        } catch (error) {
            console.error('Form submission error:', error);
            alert('אירעה שגיאה בשליחת הטופס: ' + error.message);
        }
    }

    // טעינת נתונים מ-localStorage בטעינת הדף
    function loadSavedData() {
        const form = document.getElementById('section4-form');
        if (form) {
            const formElements = form.elements;
            for (let element of formElements) {
                const savedValue = localStorage.getItem(`section4_${element.name}`);
                if (savedValue) {
                    if (element.type === 'checkbox') {
                        element.checked = savedValue === 'true';
                    } else {
                        element.value = savedValue;
                    }
                }
            }
        }
    }

    // טעינת נתונים בטעינת הדף
    loadSavedData();
});
