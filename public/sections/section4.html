// section4.js
document.addEventListener('DOMContentLoaded', function() {
    const declarations = {
        declaration1: false,
        declaration2: false,
        declaration3: false
    };

    // ניהול האקורדיון
    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', function() {
            const content = this.nextElementSibling;
            const icon = this.querySelector('.accordion-icon');
            const isOpen = content.classList.contains('open');
            const declarationId = this.closest('.accordion-item').dataset.declaration;

            // סגירת כל האקורדיונים האחרים
            document.querySelectorAll('.accordion-content').forEach(item => {
                item.classList.remove('open');
                item.style.maxHeight = null;
                item.previousElementSibling.querySelector('.accordion-icon').textContent = '▼';
            });

            // פתיחת האקורדיון הנוכחי
            if (!isOpen) {
                content.classList.add('open');
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.textContent = '▲';
                
                setTimeout(() => {
                    declarations[declarationId] = true;
                    updateProgressMarkers();
                    checkAllDeclarationsRead();
                }, 1000);
            }
        });
    });

    // עדכון סמני התקדמות
    function updateProgressMarkers() {
        Object.entries(declarations).forEach(([id, isRead]) => {
            const marker = document.querySelector(`.progress-marker[data-declaration="${id}"]`);
            if (marker) {
                if (isRead) {
                    marker.classList.add('completed');
                } else {
                    marker.classList.remove('completed');
                }
            }
        });
    }

    // בדיקת קריאת כל ההצהרות
    function checkAllDeclarationsRead() {
        const allRead = Object.values(declarations).every(val => val);
        const finalCheckbox = document.querySelector('input[name="finalConfirmation"]');
        
        if (finalCheckbox) {
            finalCheckbox.disabled = !allRead;
            if (allRead) {
                finalCheckbox.closest('.final-confirmation').classList.add('enabled');
            }
        }
    }

    // טיפול בכפתור שליחה
    document.getElementById('finalSubmit').addEventListener('click', async function(e) {
        e.preventDefault();
        console.log('Submit button clicked');

        // בדיקת חתימה
        const signatureData = document.getElementById('signatureCanvas4-data').value;
        console.log('Checking signature data:', !!signatureData);

        if (!signatureData) {
            alert('נא להוסיף חתימה דיגיטלית');
            const signatureContainer = document.querySelector('.signature-container');
            signatureContainer.scrollIntoView({ behavior: 'smooth' });
            return;
        }

        // בדיקת תיבות סימון
        const allChecked = ['riskAcknowledgement', 'independentDecision', 'updateCommitment', 'finalConfirmation']
            .every(name => {
                const checked = document.querySelector(`input[name="${name}"]`).checked;
                console.log(`Checkbox ${name}:`, checked);
                return checked;
            });

        if (!allChecked) {
            alert('נא לקרוא ולאשר את כל ההצהרות');
            return;
        }

        await submitForm();
    });

    // שליחת הטופס
    async function submitForm() {
        try {
            const form = document.getElementById('section4-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            console.log('Submitting form data:', data);

            const response = await fetch('/api/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error('שגיאה בשליחת הטופס');
            }

            const result = await response.json();
            
            if (result.success) {
                alert('הטופס נשלח בהצלחה!');
                window.location.href = '/thank-you.html';
            } else {
                throw new Error(result.message || 'שגיאה בשליחת הטופס');
            }
        } catch (error) {
            console.error('Form submission error:', error);
            alert('אירעה שגיאה בשליחת הטופס: ' + error.message);
        }
    }
});
