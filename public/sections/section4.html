<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הסכם שיווק השקעות - הצהרות</title>
    <link href="/css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Header with Logo -->
    <header class="form-header">
        <img src="/images/movne-logo.png" alt="מובנה" class="logo">
        <h1>הסכם שיווק השקעות חד פעמי למוצרים מובנים</h1>
    </header>

    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-steps">
            <div class="step completed" data-step="1">
                <div class="step-circle">
                    <span class="step-number">1</span>
                    <span class="step-check">✓</span>
                </div>
                <div class="step-label">פרטים אישיים</div>
            </div>
            <div class="step completed" data-step="2">
                <div class="step-circle">
                    <span class="step-number">2</span>
                    <span class="step-check">✓</span>
                </div>
                <div class="step-label">פרטי השקעה</div>
            </div>
            <div class="step completed" data-step="3">
                <div class="step-circle">
                    <span class="step-number">3</span>
                    <span class="step-check">✓</span>
                </div>
                <div class="step-label">שאלון סיכון</div>
            </div>
            <div class="step active" data-step="4">
                <div class="step-circle">
                    <span class="step-number">4</span>
                    <span class="step-check">✓</span>
                </div>
                <div class="step-label">הצהרות</div>
            </div>
        </div>
    </div>

    <!-- Form Content -->
    <main class="form-content">
        <form id="section4-form" class="form-section">
            <!-- Declarations Accordion -->
            <div class="accordion-container">
                <div class="accordion-item" data-declaration="declaration1">
                    <button type="button" class="accordion-header">
                        <span class="accordion-title">הצהרת הבנת סיכונים</span>
                        <span class="accordion-icon">▼</span>
                    </button>
                    <div class="accordion-content">
                        <p class="mb-4">
                            אני מצהיר/ה בזאת כי הובהר לי שההשקעה במוצרים מובנים כרוכה בסיכונים מיוחדים, לרבות:
                        </p>
                        <ul class="declaration-list">
                            <li>סיכון לאובדן חלק או כל הקרן המושקעת</li>
                            <li>סיכוני שוק ותנודתיות</li>
                            <li>סיכוני נזילות ואפשרות מוגבלת למכירה לפני מועד הפירעון</li>
                            <li>סיכוני מטבע ושערי חליפין במידה ורלוונטי</li>
                            <li>תלות בחוסנם הפיננסי של מנפיקי המוצרים המובנים</li>
                            <li>מורכבות המוצרים והקושי בהערכת שווים</li>
                        </ul>
                        <label class="checkbox-container mt-4">
                            <input type="checkbox" name="riskAcknowledgement" required>
                            <span class="checkmark"></span>
                            קראתי והבנתי את כל הסיכונים המפורטים לעיל
                        </label>
                    </div>
                </div>

                <div class="accordion-item" data-declaration="declaration2">
                    <button type="button" class="accordion-header">
                        <span class="accordion-title">הצהרת אי הסתמכות והחלטה עצמאית</span>
                        <span class="accordion-icon">▼</span>
                    </button>
                    <div class="accordion-content">
                        <p class="mb-4">אני מצהיר/ה בזאת כי:</p>
                        <ul class="declaration-list">
                            <li>ההחלטה להשקיע במוצרים מובנים התקבלה על פי שיקול דעתי העצמאי בלבד</li>
                            <li>איני מסתמך/ת על עצות או המלצות של החברה או מי מטעמה</li>
                            <li>הובהר לי שהחברה אינה משמשת כיועץ השקעות ואינה מספקת ייעוץ אישי</li>
                            <li>בדקתי את התאמת ההשקעה לצרכיי ולמטרותיי הפיננסיות</li>
                            <li>אני מבין/ה שביצועי עבר אינם מעידים על ביצועים עתידיים</li>
                        </ul>
                        <label class="checkbox-container mt-4">
                            <input type="checkbox" name="independentDecision" required>
                            <span class="checkmark"></span>
                            אני מאשר/ת את כל ההצהרות הנ"ל
                        </label>
                    </div>
                </div>

                <div class="accordion-item" data-declaration="declaration3">
                    <button type="button" class="accordion-header">
                        <span class="accordion-title">התחייבות לעדכון פרטים</span>
                        <span class="accordion-icon">▼</span>
                    </button>
                    <div class="accordion-content">
                        <p class="mb-4">אני מתחייב/ת בזאת:</p>
                        <ul class="declaration-list">
                            <li>לעדכן את החברה בכתב על כל שינוי מהותי בפרטים שמסרתי בטופס זה</li>
                            <li>להודיע מיידית על כל שינוי במצבי הפיננסי שעשוי להשפיע על השקעותיי</li>
                            <li>לעדכן על שינויים בנסיבות האישיות שעשויים להשפיע על פרופיל הסיכון שלי</li>
                            <li>להודיע על שינויים במטרות ההשקעה או באופק ההשקעה המתוכנן</li>
                        </ul>
                        <label class="checkbox-container mt-4">
                            <input type="checkbox" name="updateCommitment" required>
                            <span class="checkmark"></span>
                            אני מתחייב/ת לעדכן על כל שינוי מהותי כמפורט לעיל
                        </label>
                    </div>
                </div>
            </div>

            <!-- Signature Section -->
            <div class="signature-section mt-6">
                <h3>חתימה דיגיטלית</h3>
                <div class="signature-container">
                    <canvas id="signatureCanvas" class="signature-canvas"></canvas>
                    <div class="signature-controls">
                        <button type="button" class="btn-secondary" data-clear-signature>נקה חתימה</button>
                        <button type="button" class="btn-secondary" data-copy-signature>הדבק חתימה קודמת</button>
                    </div>
                </div>
                <input type="hidden" id="signatureData" name="signature" required>
            </div>

            <!-- Final Confirmation -->
            <div class="final-confirmation mt-6">
                <label class="checkbox-container">
                    <input type="checkbox" name="finalConfirmation" required>
                    <span class="checkmark"></span>
                    <span class="text-bold">
                        אני מאשר/ת שקראתי והבנתי את כל ההצהרות לעיל, ומסכים/ה להן באופן מלא ובלתי חוזר
                    </span>
                </label>
            </div>
        </form>
    </main>

    <!-- Navigation -->
    <footer class="form-navigation">
        <div class="container">
            <button type="button" id="btnBack" class="btn-prev">חזור</button>
            <button type="button" id="finalSubmit" class="btn-next" disabled>סיים והגש טופס</button>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="/js/signatureHandler.js"></script>
    <script src="/js/accordion.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/navigation.js"></script>
    <script src="/js/googleSheetsSubmit.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('#section4-form');
            const submitButton = document.getElementById('finalSubmit');

            // Function to check form validity
            function checkFormValidity() {
                const allCheckboxesChecked = 
                    form.querySelector('input[name="riskAcknowledgement"]').checked &&
                    form.querySelector('input[name="independentDecision"]').checked &&
                    form.querySelector('input[name="updateCommitment"]').checked &&
                    form.querySelector('input[name="finalConfirmation"]').checked;

                const hasSignature = window.signatureHandler && 
                                   !window.signatureHandler.signaturePad.isEmpty();

                submitButton.disabled = !(allCheckboxesChecked && hasSignature);
            }

            // Add event listeners for form changes
            form.addEventListener('change', checkFormValidity);

            // Monitor signature changes
            if (window.signatureHandler) {
                window.signatureHandler.signaturePad.on('endStroke', checkFormValidity);
            }

            // Handle form submission
            submitButton.addEventListener('click', async function(e) {
                e.preventDefault();
                
                if (form.checkValidity() && window.signatureHandler && 
                    !window.signatureHandler.signaturePad.isEmpty()) {
                    
                    const buttonText = this.innerHTML;
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner"></span>';

                    try {
                        // Save current form data
                        const formData = new FormData(form);
                        const dataToSave = {};
                        formData.forEach((value, key) => {
                            dataToSave[key] = value;
                        });

                        // Add signature
                        const signatureData = document.getElementById('signatureData').value;
                        if (signatureData) {
                            dataToSave.signature = signatureData;
                        }

                        // Save to localStorage
                        localStorage.setItem('section4Data', JSON.stringify(dataToSave));

                        // Submit to Google Sheets
                        const success = await window.submitFormToGoogleSheets();

                        if (success) {
                            // Clear all stored data
                            localStorage.clear();
                            window.location.href = '/sections/preview.html';
                        } else {
                            throw new Error('Failed to submit form');
                        }
                    } catch (error) {
                        console.error('Submission error:', error);
                        alert('אירעה שגיאה בשליחת הטופס. נא לנסות שוב.');
                        this.disabled = false;
                        this.innerHTML = buttonText;
                    }
                } else {
                    if (!window.signatureHandler.signaturePad.isEmpty()) {
                        alert('נא למלא את כל השדות הנדרשים');
                    } else {
                        alert('נא להוסיף חתימה');
                    }
                }
            });

            // Handle back button
            document.getElementById('btnBack').addEventListener('click', function() {
                window.location.href = '/sections/section3.html';
            });

            // Load saved data
            const savedData = localStorage.getItem('section4Data');
            if (savedData) {
                const data = JSON.parse(savedData);
                Object.entries(data).forEach(([key, value]) => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input && input.type === 'checkbox') {
                        input.checked = value === 'on';
                    }
                });
            }

            // Initial validity check
            checkFormValidity();
        });
    </script>
</body>
</html>
